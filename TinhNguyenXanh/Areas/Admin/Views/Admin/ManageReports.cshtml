@using TinhNguyenXanh.Models
@model IEnumerable<EventReport>

@{
    ViewData["Title"] = "Quản lý báo cáo vi phạm";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    var currentStatus = Context.Request.Query["status"].ToString();
    if (string.IsNullOrEmpty(currentStatus)) currentStatus = "all";
}

<h2 class="mb-4">
    Báo cáo vi phạm hoạt động
</h2>

<!-- Bộ lọc trạng thái -->
<div class="mb-4">
    <div class="btn-group" role="group">
        <a asp-action="ManageReports" asp-route-status="all"
           class="btn @(currentStatus == "all" ? "btn-primary" : "btn-outline-primary")">Tất cả</a>
        <a asp-action="ManageReports" asp-route-status="Pending"
           class="btn @(currentStatus == "Pending" ? "btn-primary" : "btn-outline-primary")">Đang chờ</a>
        <a asp-action="ManageReports" asp-route-status="Reviewed"
           class="btn @(currentStatus == "Reviewed" ? "btn-primary" : "btn-outline-primary")">Đã xem</a>
        <a asp-action="ManageReports" asp-route-status="Resolved"
           class="btn @(currentStatus == "Resolved" ? "btn-primary" : "btn-outline-primary")">Đã xử lý</a>
    </div>
</div>

<!-- Danh sách báo cáo -->
<div class="card">
    <div class="card-body p-0">
        @if (!Model.Any())
        {
            <div class="text-center py-5">
                <i class="bi bi-shield-check text-success" style="font-size: 4rem;"></i>
                <h5 class="mt-3">Không có báo cáo vi phạm nào</h5>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th>Ngày báo cáo</th>
                            <th>Người báo cáo</th>
                            <th>Hoạt động</th>
                            <th>Lý do</th>
                            <th>Trạng thái</th>
                            <th class="text-center">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var r in Model.OrderByDescending(x => x.ReportDate))
                        {
                            var isPending = r.Status == "Pending";

                            <tr class="@(isPending ? "table-warning" : "")">
                                <td>
                                    <strong>@r.ReportDate.ToString("dd/MM/yyyy")</strong><br>
                                    <small class="text-muted">@r.ReportDate.ToString("HH:mm")</small>
                                </td>
                                <td>
                                    <div>
                                        <strong>@(r.User?.UserName ?? "Đã xóa")</strong><br>
                                        <small class="text-muted">@(r.User?.Email ?? r.ReporterUserId)</small>
                                    </div>
                                </td>
                                <td>
                                    <a href="/event/detail/@r.EventId" target="_blank" class="text-decoration-none">
                                        <strong>@(r.Event?.Title ?? "Hoạt động đã xóa")</strong>
                                    </a>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#reasonModal@r.Id">
                                        Xem lý do
                                    </button>
                                </td>
                                <td>
                                    <span class="badge @(r.Status switch {
                                        "Pending" => "bg-warning text-dark",
                                        "Reviewed" => "bg-info",
                                        "Resolved" => "bg-success",
                                        "Dismissed" => "bg-secondary",
                                        _ => "bg-danger"
                                    })">
                                        @(r.Status == "Pending" ? "Đang chờ" :
                                          r.Status == "Reviewed" ? "Đã xem" :
                                          r.Status == "Resolved" ? "Đã xử lý" :
                                          r.Status == "Dismissed" ? "Bác bỏ" : r.Status)
                                    </span>
                                </td>
                                <td class="text-center">
                                    @if (isPending)
                                    {
                                        <div class="btn-group" role="group">
                                            <form asp-action="UpdateReportStatus" asp-route-reportId="@r.Id" asp-route-newStatus="Reviewed" method="post" class="d-inline">
                                                <button type="submit" class="btn btn-info btn-sm" title="Đánh dấu đã xem">
                                                    Đã xem
                                                </button>
                                            </form>
                                            <form asp-action="UpdateReportStatus" asp-route-reportId="@r.Id" asp-route-newStatus="Resolved" method="post" class="d-inline">
                                                <button type="submit" class="btn btn-success btn-sm" title="Xử lý xong">
                                                    Đã xử lý
                                                </button>
                                            </form>
                                            <button type="button" class="btn btn-secondary btn-sm" title="Bác bỏ"
                                                    onclick="updateStatus(@r.Id, 'Dismissed')">
                                                    Bác bỏ
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">Đã xử lý</span>
                                    }

                                    <form asp-action="DeleteReport" asp-route-reportId="@r.Id" method="post" class="d-inline">
                                        <button type="submit" class="btn btn-outline-danger btn-sm ms-1" title="Xóa báo cáo"
                                                onclick="return confirm('Xóa báo cáo này?')">
                                            Xóa
                                        </button>
                                    </form>
                                </td>
                            </tr>

                            <!-- Modal xem lý do -->
                            <div class="modal fade" id="reasonModal@r.Id" tabindex="-1">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header bg-danger text-white">
                                            <h5 class="modal-title">Lý do báo cáo vi phạm</h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                        </div>
                                        <div class="modal-body">
                                            <p><strong>Người báo:</strong> @(r.User?.UserName ?? "Ẩn danh")</p>
                                            <p><strong>Thời gian:</strong> @r.ReportDate.ToString("dd/MM/yyyy HH:mm")</p>
                                            <hr>
                                            <p class="lead">@r.ReportReason</p>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                            <a href="/event/detail/@r.EventId" target="_blank" class="btn btn-primary">
                                                Xem hoạt động
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<!-- Script nhỏ để xử lý bác bỏ -->
<script>
    function updateStatus(reportId, status) {
        if (confirm('Bạn có chắc muốn đánh dấu báo cáo này là "' + status + '"?')) {
            const form = document.createElement('form');
            form.method = 'post';
            form.action = '/admin/reports/update-status/' + reportId;
            
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'newStatus';
            input.value = status;
            
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }
    }
</script>