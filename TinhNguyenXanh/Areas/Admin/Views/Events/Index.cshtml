@* @model IEnumerable<TinhNguyenXanh.Areas.Admin.Models.EventAdminListViewModel>
@{
    // ViewData["Title"] = "Quản lý Hoạt động";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<style>
    :root {
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --dark: #1e293b;
        --border: #e2e8f0;
    }

    body {
        background: #e4f3e9;
        font-family: 'Segoe UI', sans-serif;
    }

    .page-header {
        font-weight: 700;
        color: var(--dark);
        font-size: 1.8rem;
    }

    .search-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        overflow: hidden;
        max-width: 500px;
    }

        .search-card .form-control {
            border: none;
            padding: 0.9rem 1.2rem;
            font-size: 1rem;
        }

        .search-card .btn {
            border: none;
            padding: 0.9rem 1.8rem;
            font-weight: 600;
        }

    .events-table {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 35px rgba(0,0,0,0.1);
    }

        .events-table thead {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .events-table th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
            padding: 1.1rem 1rem !important;
        }

        .events-table tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

            .events-table tbody tr:hover {
                background: #f0fdf4 !important;
                transform: translateY(-3px);
                box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            }

    .event-image {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .category-text {
        color: #16a34a;
        font-weight: 600;
    }

    .action-buttons {
        display: flex;
        gap: 14px;
        justify-content: center;
        align-items: center;
    }

    .btn-action {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
    }

        .btn-action:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.3);
        }

    /* Phân trang đẹp */
    .pagination .page-link {
        color: var(--success);
        background: white;
        border: 1.5px solid #86efac;
        border-radius: 50% !important;
        width: 42px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 5px;
        font-weight: 600;
        transition: all 0.3s;
    }

        .pagination .page-item.active .page-link,
        .pagination .page-link:hover {
            background: var(--success);
            color: white;
            border-color: var(--success);
            box-shadow: 0 4px 15px rgba(16,185,129,0.4);
        }
</style>

<div class="container-fluid px-4 mt-4">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-5 gap-4">
        <h3 class="page-header">Quản lý Hoạt động</h3>
        <form asp-action="Index" method="get" class="search-card">
            <div class="input-group">
                <input type="text" name="search" value="@ViewBag.Search"
                       class="form-control" placeholder="Tìm tiêu đề, tổ chức,..." autocomplete="off" />
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-search me-2"></i>
                </button>
            </div>
        </form>
    </div>

    <div class="card events-table border-0">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">Ảnh</th>
                            <th>Tiêu đề hoạt động</th>
                            <th>Tổ chức</th>
                            <th>Danh mục</th>
                            <th>Thời gian</th>
                            <th class="text-center">Báo cáo</th>
                            <th class="text-center">Trạng thái</th>
                            <th class="text-center">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var e in Model)
                        {
                            var firstImage = !string.IsNullOrWhiteSpace(e.ImageUrl)
                            ? e.ImageUrl.Split(',')[0].Trim()
                            : null;

                            <tr class="event-row" data-id="@e.Id">
                                <td class="ps-4">
                                    @if (!string.IsNullOrEmpty(firstImage))
                                    {
                                        <img src="@firstImage" class="event-image" alt="Ảnh" />
                                    }
                                    else
                                    {
                                        <div class="bg-light event-image d-flex align-items-center justify-content-center rounded">
                                            <i class="fas fa-image text-muted fa-2x"></i>
                                        </div>
                                    }
                                </td>
                                <td><strong class="text-dark">@e.Title</strong></td>
                                <td>@e.OrganizerName</td>
                                <td><span class="category-text">@e.CategoryName</span></td>
                                <td>
                                    <small class="text-muted d-block">Bắt đầu</small>
                                    @(((DateTime)e.StartTime).ToString("dd/MM/yyyy HH:mm"))
                                </td>
                                <td class="text-center">
                                    @if (e.ReportCount > 0)
                                    {
                                        <span class="badge bg-danger rounded-pill px-3 py-2">
                                            @e.ReportCount
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-success fw-600">Không có</span>
                                    }
                                </td>
                                <td class="text-center">
                                    <span class="badge @(e.IsHidden ? "bg-secondary" : "bg-success") py-2 px-4 fw-bold rounded-pill">
                                        @(e.IsHidden ? "Đã ẩn" : "Đang hiển thị")
                                    </span>
                                </td>
                                <td class="text-center" onclick="event.stopPropagation();">
                                    <div class="action-buttons">
                                        <!-- NÚT ẨN / HIỆN – CHỈ CÒN ICON MẮT -->
                                        <button class="btn @(e.IsHidden ? "btn-success" : "btn-warning") btn-action toggle-hide-btn"
                                                data-id="@e.Id"
                                                data-hidden="@e.IsHidden.ToString().ToLower()"
                                                title="@(e.IsHidden ? "Hiện hoạt động" : "Ẩn hoạt động")">
                                            <i class="fas @(e.IsHidden ? "fa-eye" : "fa-eye-slash")"></i>
                                        </button>

                                        <!-- NÚT XÓA – CHỈ CÒN ICON THÙNG RÁC -->
                                        <button class="btn btn-danger btn-action delete-btn"
                                                data-id="@e.Id"
                                                title="Xóa vĩnh viễn">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (ViewBag.TotalPages > 1)
            {
                <nav class="p-4 bg-light border-top">
                    <ul class="pagination justify-content-center mb-0">
                        @for (int i = 1; i <= ViewBag.TotalPages; i++)
                        {
                            <li class="page-item @(i == ViewBag.Page ? "active" : "")">
                                <a class="page-link" href="@Url.Action("Index", new { search = ViewBag.Search, page = i })">@i</a>
                            </li>
                        }
                    </ul>
                </nav>
            }
        </div>
    </div>
</div>

<!-- Modal chi tiết -->
<div class="modal fade" id="eventDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Chi tiết hoạt động</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

        // Click dòng → mở modal
        document.querySelectorAll('.event-row').forEach(row => {
            row.addEventListener('click', () => openDetail(row.dataset.id));
        });

        async function openDetail(id) {
            try {
                const res = await fetch(`/Admin/Events/Details/${id}`);
                if (!res.ok) throw new Error();
                const data = await res.json();

                const reportsHtml = data.reports.length === 0
                    ? `<div class="text-center text-success py-5">Chưa có báo cáo nào</div>`
                    : data.reports.map(r => `
                        <div class="border-start border-danger border-4 ps-4 py-3 mb-3 bg-light rounded">
                            <strong>${r.reporterName}</strong> <small class="text-muted">(${r.reporterEmail})</small><br>
                            <span class="text-danger"><strong>Lý do:</strong> ${r.reason || 'Không ghi rõ'}</span><br>
                            <small class="text-muted">${new Date(r.reportedAt).toLocaleString('vi-VN')}</small>
                        </div>
                    `).join('');

                document.getElementById('modalBody').innerHTML = `
                    <div class="row g-4">
                        <div class="col-lg-4 text-center">
                            ${data.imageUrl ? `<img src="${data.imageUrl.split(',')[0].trim()}" class="img-fluid rounded shadow" style="max-height:380px;object-fit:cover;">`
                                : `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="height:380px;"><i class="fas fa-image text-muted fa-5x"></i></div>`}
                        </div>
                        <div class="col-lg-8">
                            <h4 class="text-success fw-bold mb-3">${data.title}</h4>
                            <table class="table table-borderless">
                                <tr><td width="130"><strong>Tổ chức:</strong></td><td>${data.organizerName}</td></tr>
                                <tr><td><strong>Danh mục:</strong></td><td><span class="category-text">${data.categoryName}</span></td></tr>
                                <tr><td><strong>Thời gian:</strong></td><td>${new Date(data.startTime).toLocaleString('vi-VN')}</td></tr>
                                <tr><td><strong>Địa điểm:</strong></td><td>${data.location || 'Chưa cập nhật'}</td></tr>
                                <tr><td><strong>Trạng thái:</strong></td><td>
                                    <span class="badge ${data.isHidden ? 'bg-secondary' : 'bg-success'} py-2 px-4 rounded-pill">
                                        ${data.isHidden ? 'Đã ẩn' : 'Đang hiển thị'}
                                    </span>
                                </td></tr>
                            </table>
                            <hr>
                            <h5 class="mb-3">Báo cáo vi phạm (${data.reports.length})</h5>
                            <div style="max-height:300px;overflow-y:auto;">${reportsHtml}</div>
                            <div class="mt-4 text-end">
                                <div class="action-buttons d-inline-flex">
                                    <button class="btn ${data.isHidden ? 'btn-success' : 'btn-warning'} btn-action me-3 toggle-hide-modal-btn"
                                            data-id="${data.id}" data-hidden="${data.isHidden}"
                                            title="${data.isHidden ? 'Hiện lại' : 'Ẩn hoạt động'}">
                                        <i class="fas ${data.isHidden ? 'fa-eye' : 'fa-eye-slash'}"></i>
                                    </button>
                                    <button class="btn btn-danger btn-action delete-modal-btn"
                                            data-id="${data.id}" title="Xóa vĩnh viễn">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                new bootstrap.Modal(document.getElementById('eventDetailModal')).show();
            } catch {
                Swal.fire('Lỗi', 'Không thể tải chi tiết hoạt động', 'error');
            }
        }

        // Toggle Hide
        async function toggleHide(id, currentHidden) {
            const willHide = !currentHidden;
            const result = await Swal.fire({
                title: willHide ? 'Ẩn hoạt động?' : 'Hiện lại hoạt động?',
                text: willHide ? 'Người dùng sẽ không thấy hoạt động này nữa' : 'Hoạt động sẽ hiển thị trở lại',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: willHide ? 'Ẩn ngay' : 'Hiện lại',
                confirmButtonColor: willHide ? '#f59e0b' : '#10b981'
            });
            if (!result.isConfirmed) return;
            Swal.fire({ title: 'Đang xử lý...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            fetch(`/Admin/Events/ToggleHide/${id}`, {
                method: 'POST',
                headers: { 'RequestVerificationToken': token }
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    Swal.fire('Thành công!', d.message, 'success').then(() => location.reload());
                } else {
                    Swal.fire('Lỗi!', d.message, 'error');
                }
            });
        }

        // Delete
        async function deleteEvent(id) {
            const result = await Swal.fire({
                title: 'Xóa vĩnh viễn hoạt động này?',
                text: "Không thể khôi phục!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Xóa luôn',
                confirmButtonColor: '#dc3545'
            });
            if (!result.isConfirmed) return;
            Swal.fire({ title: 'Đang xóa...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            fetch(`/Admin/Events/Delete/${id}`, {
                method: 'POST',
                headers: { 'RequestVerificationToken': token }
            }).then(() => location.reload());
        }

        // Event cho nút trong modal (dynamic)
        document.getElementById('modalBody').addEventListener('click', e => {
            const toggleBtn = e.target.closest('.toggle-hide-modal-btn');
            const delBtn = e.target.closest('.delete-modal-btn');
            if (toggleBtn) toggleHide(toggleBtn.dataset.id, toggleBtn.dataset.hidden === 'true');
            if (delBtn) deleteEvent(delBtn.dataset.id);
        });

        // Event cho nút trong bảng (static)
        document.querySelectorAll('.toggle-hide-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                e.stopPropagation();
                toggleHide(btn.dataset.id, btn.dataset.hidden === "true");
            });
        });
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                e.stopPropagation();
                deleteEvent(btn.dataset.id);
            });
        });
    </script>
} *@

@model IEnumerable<TinhNguyenXanh.Areas.Admin.Models.EventAdminListViewModel>
@{
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}

<style>
    :root {
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --dark: #1e293b;
        --border: #e2e8f0;
    }

    body {
        background: #e4f3e9;
        font-family: 'Segoe UI', sans-serif;
    }

    .page-header {
        font-weight: 700;
        color: var(--dark);
        font-size: 1.8rem;
    }

    /* ==== FADE-IN EFFECT ==== */
    .fade-in {
        opacity: 0;
        transform: translateY(30px);
        transition: all 0.7s ease;
    }

        .fade-in.delay-1 {
            transition-delay: 0.1s;
        }

        .fade-in.delay-2 {
            transition-delay: 0.2s;
        }

        .fade-in.delay-3 {
            transition-delay: 0.3s;
        }

        .fade-in.delay-4 {
            transition-delay: 0.4s;
        }

    .search-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        overflow: hidden;
        max-width: 500px;
    }

        .search-card .form-control {
            border: none;
            padding: 0.9rem 1.2rem;
            font-size: 1rem;
        }

        .search-card .btn {
            border: none;
            padding: 0.9rem 1.8rem;
            font-weight: 600;
        }

    .events-table {
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 10px 35px rgba(0,0,0,0.1);
    }

        .events-table thead {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .events-table th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
            padding: 1.1rem 1rem !important;
        }

        .events-table tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

            .events-table tbody tr:hover {
                background: #f0fdf4 !important;
                transform: translateY(-3px);
                box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            }

    .event-image {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .category-text {
        color: #16a34a;
        font-weight: 600;
    }

    .action-buttons {
        display: flex;
        gap: 14px;
        justify-content: center;
        align-items: center;
    }

    .btn-action {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
    }

        .btn-action:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.3);
        }

    /* Phân trang đẹp */
    .pagination .page-link {
        color: var(--success);
        background: white;
        border: 1.5px solid #86efac;
        border-radius: 50% !important;
        width: 42px;
        height: 42px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 5px;
        font-weight: 600;
        transition: all 0.3s;
    }

        .pagination .page-item.active .page-link,
        .pagination .page-link:hover {
            background: var(--success);
            color: white;
            border-color: var(--success);
            box-shadow: 0 4px 15px rgba(16,185,129,0.4);
        }
</style>

<div class="container-fluid px-4 mt-4">
    <!-- HEADER + SEARCH -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-5 gap-4 fade-in delay-1">
        <h3 class="page-header">Quản lý Hoạt động</h3>
        <form asp-action="Index" method="get" class="search-card fade-in delay-2">
            <div class="input-group">
                <input type="text" name="search" value="@ViewBag.Search"
                       class="form-control" placeholder="Tìm tiêu đề, tổ chức,..." autocomplete="off" />
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-search me-2"></i>
                </button>
            </div>
        </form>
    </div>

    <!-- TABLE -->
    <div class="card events-table border-0 fade-in delay-3">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead>
                        <tr>
                            <th class="ps-4">Ảnh</th>
                            <th>Tiêu đề hoạt động</th>
                            <th>Tổ chức</th>
                            <th>Danh mục</th>
                            <th>Thời gian</th>
                            <th class="text-center">Báo cáo</th>
                            <th class="text-center">Trạng thái</th>
                            <th class="text-center">Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var e in Model.Select((ev, i) => new { Event = ev, Index = i }))
                        {
                            var firstImage = !string.IsNullOrWhiteSpace(e.Event.ImageUrl)
                            ? e.Event.ImageUrl.Split(',')[0].Trim()
                            : null;

                            <tr class="event-row fade-in delay-@((e.Index % 4) + 1)" data-id="@e.Event.Id">
                                <td class="ps-4">
                                    @if (!string.IsNullOrEmpty(firstImage))
                                    {
                                        <img src="@firstImage" class="event-image" alt="Ảnh" />
                                    }
                                    else
                                    {
                                        <div class="bg-light event-image d-flex align-items-center justify-content-center rounded">
                                            <i class="fas fa-image text-muted fa-2x"></i>
                                        </div>
                                    }
                                </td>
                                <td><strong class="text-dark">@e.Event.Title</strong></td>
                                <td>@e.Event.OrganizerName</td>
                                <td><span class="category-text">@e.Event.CategoryName</span></td>
                                <td>
                                    <small class="text-muted d-block">Bắt đầu</small>
                                    @(((DateTime)e.Event.StartTime).ToString("dd/MM/yyyy HH:mm"))
                                </td>
                                <td class="text-center">
                                    @if (e.Event.ReportCount > 0)
                                    {
                                        <span class="badge bg-danger rounded-pill px-3 py-2">
                                            @e.Event.ReportCount
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="text-success fw-600">Không có</span>
                                    }
                                </td>
                                <td class="text-center">
                                    <span class="badge @(e.Event.IsHidden ? "bg-secondary" : "bg-success") py-2 px-4 fw-bold rounded-pill">
                                        @(e.Event.IsHidden ? "Đã ẩn" : "Đang hiển thị")
                                    </span>
                                </td>
                                <td class="text-center" onclick="event.stopPropagation();">
                                    <div class="action-buttons">
                                        <button class="btn @(e.Event.IsHidden ? "btn-success" : "btn-warning") btn-action toggle-hide-btn"
                                                data-id="@e.Event.Id"
                                                data-hidden="@e.Event.IsHidden.ToString().ToLower()"
                                                title="@(e.Event.IsHidden ? "Hiện hoạt động" : "Ẩn hoạt động")">
                                            <i class="fas @(e.Event.IsHidden ? "fa-eye" : "fa-eye-slash")"></i>
                                        </button>

                                        <button class="btn btn-danger btn-action delete-btn"
                                                data-id="@e.Event.Id"
                                                title="Xóa vĩnh viễn">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            @if (ViewBag.TotalPages > 1)
            {
                <nav class="p-4 bg-light border-top fade-in delay-4">
                    <ul class="pagination justify-content-center mb-0">
                        @for (int i = 1; i <= ViewBag.TotalPages; i++)
                        {
                            <li class="page-item @(i == ViewBag.Page ? "active" : "")">
                                <a class="page-link" href="@Url.Action("Index", new { search = ViewBag.Search, page = i })">@i</a>
                            </li>
                        }
                    </ul>
                </nav>
            }
        </div>
    </div>
</div>

<!-- Modal chi tiết -->
<div class="modal fade" id="eventDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Chi tiết hoạt động</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

        /* === FADE-IN OBSERVER === */
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(e => {
                if (e.isIntersecting) {
                    e.target.style.opacity = 1;
                    e.target.style.transform = 'translateY(0)';
                }
            });
        }, { threshold: 0.1 });
        document.querySelectorAll('.fade-in').forEach(el => observer.observe(el));

        // Click dòng → mở modal
        document.querySelectorAll('.event-row').forEach(row => {
            row.addEventListener('click', () => openDetail(row.dataset.id));
        });

        async function openDetail(id) {
            try {
                const res = await fetch(`/Admin/Events/Details/${id}`);
                if (!res.ok) throw new Error();
                const data = await res.json();

                const reportsHtml = data.reports.length === 0
                    ? `<div class="text-center text-success py-5">Chưa có báo cáo nào</div>`
                    : data.reports.map(r => `
                        <div class="border-start border-danger border-4 ps-4 py-3 mb-3 bg-light rounded">
                            <strong>${r.reporterName}</strong> <small class="text-muted">(${r.reporterEmail})</small><br>
                            <span class="text-danger"><strong>Lý do:</strong> ${r.reason || 'Không ghi rõ'}</span><br>
                            <small class="text-muted">${new Date(r.reportedAt).toLocaleString('vi-VN')}</small>
                        </div>
                    `).join('');

                document.getElementById('modalBody').innerHTML = `
                    <div class="row g-4">
                        <div class="col-lg-4 text-center">
                            ${data.imageUrl ? `<img src="${data.imageUrl.split(',')[0].trim()}" class="img-fluid rounded shadow" style="max-height:380px;object-fit:cover;">`
                                : `<div class="bg-light rounded d-flex align-items-center justify-content-center" style="height:380px;"><i class="fas fa-image text-muted fa-5x"></i></div>`}
                        </div>
                        <div class="col-lg-8">
                            <h4 class="text-success fw-bold mb-3">${data.title}</h4>
                            <table class="table table-borderless">
                                <tr><td width="130"><strong>Tổ chức:</strong></td><td>${data.organizerName}</td></tr>
                                <tr><td><strong>Danh mục:</strong></td><td><span class="category-text">${data.categoryName}</span></td></tr>
                                <tr><td><strong>Thời gian:</strong></td><td>${new Date(data.startTime).toLocaleString('vi-VN')}</td></tr>
                                <tr><td><strong>Địa điểm:</strong></td><td>${data.location || 'Chưa cập nhật'}</td></tr>
                                <tr><td><strong>Trạng thái:</strong></td><td>
                                    <span class="badge ${data.isHidden ? 'bg-secondary' : 'bg-success'} py-2 px-4 rounded-pill">
                                        ${data.isHidden ? 'Đã ẩn' : 'Đang hiển thị'}
                                    </span>
                                </td></tr>
                            </table>
                            <hr>
                            <h5 class="mb-3">Báo cáo vi phạm (${data.reports.length})</h5>
                            <div style="max-height:300px;overflow-y:auto;">${reportsHtml}</div>
                            <div class="mt-4 text-end">
                                <div class="action-buttons d-inline-flex">
                                    <button class="btn ${data.isHidden ? 'btn-success' : 'btn-warning'} btn-action me-3 toggle-hide-modal-btn"
                                            data-id="${data.id}" data-hidden="${data.isHidden}"
                                            title="${data.isHidden ? 'Hiện lại' : 'Ẩn hoạt động'}">
                                        <i class="fas ${data.isHidden ? 'fa-eye' : 'fa-eye-slash'}"></i>
                                    </button>
                                    <button class="btn btn-danger btn-action delete-modal-btn"
                                            data-id="${data.id}" title="Xóa vĩnh viễn">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                new bootstrap.Modal(document.getElementById('eventDetailModal')).show();
            } catch {
                Swal.fire('Lỗi', 'Không thể tải chi tiết hoạt động', 'error');
            }
        }

        // Toggle Hide
        async function toggleHide(id, currentHidden) {
            const willHide = !currentHidden;
            const result = await Swal.fire({
                title: willHide ? 'Ẩn hoạt động?' : 'Hiện lại hoạt động?',
                text: willHide ? 'Người dùng sẽ không thấy hoạt động này nữa' : 'Hoạt động sẽ hiển thị trở lại',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: willHide ? 'Ẩn ngay' : 'Hiện lại',
                confirmButtonColor: willHide ? '#f59e0b' : '#10b981'
            });
            if (!result.isConfirmed) return;
            Swal.fire({ title: 'Đang xử lý...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            fetch(`/Admin/Events/ToggleHide/${id}`, {
                method: 'POST',
                headers: { 'RequestVerificationToken': token }
            })
            .then(r => r.json())
            .then(d => {
                if (d.success) Swal.fire('Thành công!', d.message, 'success').then(() => location.reload());
                else Swal.fire('Lỗi!', d.message, 'error');
            });
        }

        // Delete
        async function deleteEvent(id) {
            const result = await Swal.fire({
                title: 'Xóa vĩnh viễn hoạt động này?',
                text: "Không thể khôi phục!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Xóa luôn',
                confirmButtonColor: '#dc3545'
            });
            if (!result.isConfirmed) return;
            Swal.fire({ title: 'Đang xóa...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            fetch(`/Admin/Events/Delete/${id}`, {
                method: 'POST',
                headers: { 'RequestVerificationToken': token }
            }).then(() => location.reload());
        }

        // Event cho nút trong modal (dynamic)
        document.getElementById('modalBody').addEventListener('click', e => {
            const toggleBtn = e.target.closest('.toggle-hide-modal-btn');
            const delBtn = e.target.closest('.delete-modal-btn');
            if (toggleBtn) toggleHide(toggleBtn.dataset.id, toggleBtn.dataset.hidden === 'true');
            if (delBtn) deleteEvent(delBtn.dataset.id);
        });

        // Event cho nút trong bảng (static)
        document.querySelectorAll('.toggle-hide-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                e.stopPropagation();
                toggleHide(btn.dataset.id, btn.dataset.hidden === "true");
            });
        });
        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                e.stopPropagation();
                deleteEvent(btn.dataset.id);
            });
        });
    </script>
}
